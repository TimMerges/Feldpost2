
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feldpostbrief Visualisierungen</title>
    <link rel="stylesheet" href="viewer-style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2"></script>
</head>
<body>
    <h1>Visualisierungen der Feldpostbriefe</h1>
    <button onclick="window.location.href='XML_Viewer.html'">â¬…ï¸ ZurÃ¼ck zum Viewer</button>

    <h2>ğŸ“… Zeitstrahl der Datumsangaben</h2>
    <canvas id="timelineChart"></canvas>

    <h2>ğŸ”  Wordcloud der wichtigsten Namen, FPN & Regimenter</h2>
    <canvas id="wordCloudCanvas" width="600" height="300"></canvas>

    <script>
        async function fetchFileList() {
            const response = await fetch('files.json');
            return await response.json();
        }

        async function parseXmlData(file) {
            const response = await fetch(file);
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            let dates = [];
            let words = [];

            xmlDoc.querySelectorAll('TextLine').forEach(line => {
                const custom = line.getAttribute('custom') || '';

                if (custom.includes('date')) {
                    const match = custom.match(/when:([\d]{4}\.[\d]{2}\.[\d]{2})/);
                    if (match) dates.push(match[1]);
                }

                if (custom.includes('person')) {
                    const first = (custom.match(/firstname:([a-zA-ZÃ¤Ã¶Ã¼Ã„Ã–ÃœÃŸ\.\-]+)/) || [])[1];
                    const last = (custom.match(/lastname:([a-zA-ZÃ¤Ã¶Ã¼Ã„Ã–ÃœÃŸ\.\-]+)/) || [])[1];
                    if (first || last) words.push(`${first ?? ''} ${last ?? ''}`.trim());
                }

                if (custom.includes('Regiment')) {
                    const reg = (custom.match(/Regiment:([a-zA-Z0-9 \.\-]+)/) || [])[1];
                    if (reg) words.push(reg);
                }

                if (custom.includes('FeldpostNr.')) {
                    const fpNr = (custom.match(/FeldpostNr\.:([a-zA-Z0-9 \.\-]+)/) || [])[1];
                    if (fpNr) words.push(`FPN ${fpNr}`);
                }

                if (custom.includes('movie')) {
                    const movieMatch = line.querySelector('Unicode')?.textContent;
                    if (movieMatch) words.push(movieMatch);
                }
            });

            return { dates, words };
        }

        async function loadData() {
            const files = await fetchFileList();
            let allDates = [];
            let allWords = [];

            for (let file of files) {
                const data = await parseXmlData(file);
                allDates.push(...data.dates);
                allWords.push(...data.words);
            }

            renderTimelineChart(allDates);
            renderWordCloud(allWords);
        }

        function renderTimelineChart(dates) {
            const counts = dates.reduce((acc, date) => {
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            const sortedDates = Object.keys(counts).sort();
            const dataPoints = sortedDates.map(date => counts[date]);

            new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'ErwÃ¤hnungen pro Datum',
                        data: dataPoints,
                        borderColor: 'blue',
                        fill: false
                    }]
                }
            });
        }

        function renderWordCloud(words) {
            const wordFreq = words.reduce((acc, word) => {
                acc[word] = (acc[word] || 0) + 1;
                return acc;
            }, {});

            const wordList = Object.entries(wordFreq).map(([word, freq]) => [word, freq]);

            WordCloud(document.getElementById('wordCloudCanvas'), { list: wordList, gridSize: 8, weightFactor: 5 });
        }

        loadData();
    </script>
</body>
</html>
